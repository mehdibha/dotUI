# dotUI Full Project Refactor Plan

## Overview

Complete refactor of dotUI architecture:
- Update `@dotui/colors` with schemas and flexible API
- Migrate `@dotui/style-system` and `@dotui/shadcn-adapter` into `@dotui/core`
- Update registry with variant groups and CI automation
- Connect components to core via `createDynamicComponent`
- Update database schemas
- Update all imports across the project

---

## Key Architectural Decisions

### 1. Schema Naming Convention
- `StyleConfig` → Input (user provides, stored in DB)
- `Theme`, `Variants` → Resolved outputs (internal use)
- No separate "resolved Style" type - StyleProvider takes `StyleConfig` directly

### 2. Database Schema
```typescript
style = pgTable("style", {
  id: uuid(),
  name: text(),
  description: text(),
  visibility: enum("public", "unlisted", "private"),
  isFeatured: boolean().default(false),
  isPreset: boolean().default(false),  // Admin-only presets
  config: jsonb().$type<StyleConfig>(),  // Single column
  userId: text(),
  createdAt: timestamp(),
  updatedAt: timestamp(),
});
```

### 3. Variants Architecture
- **Flat internally**: `{ button: 'basic', input: 'underline', ... }`
- **Groups for UI only**: Defined in registry meta.ts, generated to `__registry__/variants.ts`
- **Only multi-variant items**: Single-variant items excluded from schema
- **Strict schemas**: Generated from registry metadata

### 4. Presets
- Stored as `Style` with `isPreset: true`
- Admin-only creation
- When applied: Copy all config EXCEPT colors (brand-related)

### 5. No Barrel Files (Client/Server Split)
- Granular exports in package.json
- Each file is its own entry point
- Avoids "use client" tainting issues

---

## Core Package File Structure

```
@dotui/core/src/
│
├── __registry__/                     # Auto-generated by build-registry
│   ├── ui.ts                         # UI component metadata
│   ├── blocks.ts                     # Block metadata
│   ├── base.ts                       # Base styles metadata
│   ├── icons.ts                      # Icons metadata
│   ├── variants.ts                   # VARIANTS + VARIANT_GROUPS constants
│   └── index.ts
│
├── schemas/                          # Zod schemas (source of truth)
│   ├── style.ts                      # styleConfigSchema
│   ├── theme.ts                      # themeConfigSchema
│   ├── colors.ts                     # colorsConfigSchema (imports from @dotui/colors)
│   ├── typography.ts                 # typographyConfigSchema
│   ├── effects.ts                    # effectsConfigSchema
│   ├── variants.ts                   # variantsConfigSchema (from __registry__)
│   ├── icons.ts                      # iconsConfigSchema
│   ├── components.ts                 # componentsConfigSchema
│   └── index.ts                      # Re-exports all schemas
│
├── types.ts                          # z.infer re-exports for clean imports
│
├── style/                            # Style creation & providers
│   ├── create-theme.ts               # ThemeConfig → Theme (uses @dotui/colors)
│   ├── create-variants.ts            # Flat passthrough + defaults
│   ├── provider.tsx                  # StyleProvider ("use client")
│   ├── theme-provider.tsx            # ThemeProvider ("use client")
│   └── variants-provider.tsx         # VariantsProvider ("use client")
│
├── components/                       # Component utilities
│   └── create-dynamic-component.tsx  # Dynamic variant resolution ("use client")
│
├── shadcn/                           # Shadcn CLI integration
│   ├── generator.ts                  # Generate registry items
│   ├── transform.ts                  # Transform items (icons, imports)
│   ├── transforms/                   # Merged from @dotui/transformers
│   │   ├── icons.ts                  # Icon library transforms
│   │   ├── imports.ts                # Import path transforms
│   │   └── index.ts                  # applyTransforms, createIconTransform, etc.
│   └── index.ts
│
└── index.ts                          # Main entry (server-safe exports only)
```

### Why `components/` for createDynamicComponent?

- It's not a provider, it's a component factory
- Separates "style context" (`style/`) from "component creation" (`components/`)
- Can add more component utilities later (e.g., `create-themed-component.tsx`)
- Clear export path: `@dotui/core/components/create-dynamic-component`

---

## Package.json Exports

```json
{
  "exports": {
    ".": "./src/index.ts",
    "./schemas": "./src/schemas/index.ts",
    "./types": "./src/types.ts",
    "./style/provider": "./src/style/provider.tsx",
    "./style/theme-provider": "./src/style/theme-provider.tsx",
    "./style/variants-provider": "./src/style/variants-provider.tsx",
    "./style/create-theme": "./src/style/create-theme.ts",
    "./style/create-variants": "./src/style/create-variants.ts",
    "./components/create-dynamic-component": "./src/components/create-dynamic-component.tsx",
    "./shadcn": "./src/shadcn/index.ts",
    "./shadcn/generator": "./src/shadcn/generator.ts",
    "./shadcn/transform": "./src/shadcn/transform.ts"
  }
}
```

---

## Schema Definitions

### StyleConfig (Top Level)
```typescript
export const styleConfigSchema = z.object({
  theme: themeConfigSchema,
  icons: iconsConfigSchema,
  variants: variantsConfigSchema,
  components: componentsConfigSchema.optional(),
});
```

### ThemeConfig
```typescript
export const themeConfigSchema = z.object({
  colors: colorsConfigSchema,
  radius: z.number(),                    // --radius-factor
  spacing: z.number(),                   // --spacing
  typography: typographyConfigSchema,
  effects: effectsConfigSchema.optional(),
});
```

### ColorsConfig (Re-export from @dotui/colors)
```typescript
import { createThemeOptionsSchema } from '@dotui/colors';

// Direct re-export - keeps DB schema in sync with @dotui/colors API
export const colorsConfigSchema = createThemeOptionsSchema;

// The schema is a discriminated union by 'algorithm':
// - algorithm: 'material' | 'contrast'
// - palettes: { primary: string, neutral?: string, success?: string | true, ... }
// - modes: Record<string, ModeConfig> (algorithm-specific)
// - Algorithm-specific options (ratios, formula, saturation for contrast, etc.)
```

### TypographyConfig
```typescript
export const typographyConfigSchema = z.object({
  heading: z.string(),
  body: z.string(),
  mono: z.string().optional(),
  baseFontSize: z.number().optional(),
  letterSpacing: z.number().optional(),
  lineHeight: z.number().optional(),
});
```

### EffectsConfig
```typescript
export const effectsConfigSchema = z.object({
  texture: z.string().optional(),
  backgroundPattern: z.string().optional(),
});
```

### VariantsConfig (Flat, Generated from Registry)
```typescript
// Auto-generated from __registry__/variants.ts
export const variantsConfigSchema = z.object({
  button: z.enum(['basic', 'ripple', '3d']).default('basic'),
  'toggle-button': z.enum(['basic', 'ripple']).default('basic'),
  input: z.enum(['basic', 'underline', 'filled']).default('basic'),
  popover: z.enum(['basic', 'modal']).default('basic'),
  'focus-style': z.enum(['ring', 'outline', 'glow']).default('ring'),
  texture: z.enum(['noise', 'grain', 'paper', 'none']).default('none'),
  // ... only multi-variant items
});
```

### ComponentsConfig (Component-Level Tokens)
```typescript
export const componentConfigSchema = z.object({
  tokens: z.record(z.string()).optional(),
  radius: radiusScaleSchema.optional(),
});

export const componentsConfigSchema = z.record(componentConfigSchema);
```

### IconsConfig
```typescript
export const iconsConfigSchema = z.object({
  library: z.enum(['lucide', 'remix', 'tabler', 'hugeicons']),
  strokeWidth: z.number(),
});
```

---

## Generated __registry__/variants.ts

```typescript
// Auto-generated by build-registry script
export const VARIANTS = {
  button: {
    options: ['basic', 'ripple', '3d'] as const,
    default: 'basic',
    group: 'buttons',
  },
  'toggle-button': {
    options: ['basic', 'ripple'] as const,
    default: 'basic',
    group: 'buttons',
  },
  input: {
    options: ['basic', 'underline', 'filled'] as const,
    default: 'basic',
    group: 'inputs',
  },
  'focus-style': {
    options: ['ring', 'outline', 'glow'] as const,
    default: 'ring',
    group: null,  // Standalone, not in a component group
  },
  texture: {
    options: ['noise', 'grain', 'paper', 'none'] as const,
    default: 'none',
    group: null,
  },
  // ... only items with 2+ variants
} as const;

// For style-editor UI grouping
export const VARIANT_GROUPS = {
  buttons: ['button', 'toggle-button', 'toggle-button-group'],
  inputs: ['input', 'text-field', 'number-field', 'search-field'],
  overlays: ['popover', 'modal', 'drawer'],
  // ...
} as const;

export type VariantKey = keyof typeof VARIANTS;
export type VariantGroupKey = keyof typeof VARIANT_GROUPS;
```

---

## Registry meta.ts Structure

```typescript
// registry/src/ui/button/meta.ts
export const meta = {
  name: 'button',
  type: 'registry:ui',
  group: 'buttons',                    // NEW: For UI grouping
  defaultVariant: 'basic',
  variants: {
    basic: { files: [...], registryDependencies: [...] },
    ripple: { files: [...] },
    '3d': { files: [...] },
  },
};
```

---

## Dependencies

```
@dotui/core
├── @dotui/colors          # Color generation algorithms
└── (no @dotui/registry)   # Registry data is auto-generated to __registry__/

@dotui/registry
└── @dotui/core            # For createDynamicComponent

@dotui/db
└── @dotui/core            # For schemas/types
```

---

# Implementation Phases

---

## Phase 0: @dotui/colors Updates ✅ COMPLETE

Update `@dotui/colors` with schemas and flexible API for core to consume.

### Tasks

1. [x] **Export Zod schemas**
   - `createThemeOptionsSchema` - Discriminated union by `algorithm` ("material" | "contrast")
   - Algorithm-specific schemas: `createContrastThemeOptionsSchema`, `createMaterialThemeOptionsSchema`
   - Mode schemas per algorithm with palette overrides support

2. [x] **Flexible createTheme API**
   - `createTheme(options)` - Unified API that routes to algorithm-specific implementation
   - Mode shorthand: `modes: { light: true }` for defaults
   - Full mode config: `modes: { light: { lightness: 97 }, dark: { lightness: 5 } }`

3. [x] **Export types**
   - `CreateThemeOptions` - z.infer of createThemeOptionsSchema
   - `CreateContrastThemeOptions`, `CreateMaterialThemeOptions` - algorithm-specific
   - `ColorScale`, `Theme`, `ThemeMode` - shared output types

4. [x] **Handle simple mode generation**
   - `palettes: { primary: "#...", success: true }` auto-generates semantic colors
   - Supports: success, danger, warning, info with sensible defaults

### Files Modified
- `packages/colors/src/schema.ts` ✅
- `packages/colors/src/theme.ts` ✅
- `packages/colors/src/index.ts` ✅
- `packages/colors/src/contrast/schema.ts` ✅
- `packages/colors/src/material/schema.ts` ✅
- `packages/colors/package.json` ✅

---

## Phase 1: Registry Updates ✅ COMPLETE

Update `@dotui/registry` with new fields and CI automation.

### Tasks

1. [x] **Add `group` field to meta.ts files**
   - Updated all `packages/registry/src/ui/*/meta.ts`
   - Added `ComponentGroup` type to `packages/registry/src/types.ts`
   - Groups: buttons, inputs, selections, overlays, feedback, navigation, data-display, date-time, color, forms, layout

2. [x] **Update build-registry script**
   - Created `scripts/build-registry.ts`
   - Generates `packages/core/src/__registry__/variants.ts`
   - Generates `VARIANTS` constant with options, default, group
   - Generates `VARIANT_GROUPS` constant for UI grouping
   - Only includes items with 2+ variants (currently: button, form, loader)

3. [x] **Set up chokidar watcher**
   - Added `dev:registry` script to root package.json
   - Watches `packages/registry/src/ui/**/meta.ts` for changes

4. [x] **Add CI check for generated files**
   - Added `check-registry` job to `.github/workflows/ci.yml`
   - Runs `pnpm build:registry` and fails if files are out of sync

### Files Modified/Created
- `packages/registry/src/types.ts` - Added `ComponentGroup` type
- `packages/registry/src/ui/*/meta.ts` - All meta files updated with `group` field
- `scripts/build-registry.ts` - Created
- `packages/core/src/__registry__/variants.ts` - Generated
- Root `package.json` - Added `build:registry`, `dev:registry` scripts
- `.github/workflows/ci.yml` - Added `check-registry` job

---

## Phase 2: Core Package ✅ COMPLETE

Create `@dotui/core` with schemas, style system, and shadcn adapter.

### Tasks

1. [x] **Create package structure**
   - Package already existed, updated exports

2. [x] **Create schemas/**
   - `schemas/colors.ts` - re-exports `createThemeOptionsSchema` from @dotui/colors
   - `schemas/typography.ts` - typographyConfigSchema
   - `schemas/effects.ts` - effectsConfigSchema
   - `schemas/icons.ts` - uses `iconLibraries` from `__registry__/icons.ts` as source of truth
   - `schemas/variants.ts` - generated from `__registry__/variants.ts`
   - `schemas/components.ts` - componentsConfigSchema
   - `schemas/theme.ts` - themeConfigSchema (combines colors, typography, effects)
   - `schemas/style.ts` - styleConfigSchema (combines theme, icons, variants, components)
   - `schemas/index.ts` - re-exports all

3. [x] **Types via z.infer**
   - Types exported directly from schema files (no separate types.ts needed)

4. [x] **Create style/**
   - `style/provider.tsx` - StyleProvider ("use client") - wraps theme + variants
   - `style/theme-provider.tsx` - ThemeProvider ("use client")
   - `style/variants-provider.tsx` - VariantsProvider ("use client") with `useVariant` hook
   - `style/index.ts` - re-exports all

5. [x] **Create components/**
   - `components/create-dynamic-component.tsx` - with Suspense, DisableSuspense context, ErrorBoundary, Skeleton
   - `components/index.ts` - re-exports

6. [ ] **Migrate shadcn/** (SKIPPED - can be done separately if needed)
   - Existing shadcn adapter code can be migrated later

### Files Created/Modified
- `packages/core/src/schemas/colors.ts`
- `packages/core/src/schemas/typography.ts`
- `packages/core/src/schemas/effects.ts`
- `packages/core/src/schemas/icons.ts`
- `packages/core/src/schemas/variants.ts`
- `packages/core/src/schemas/components.ts`
- `packages/core/src/schemas/theme.ts`
- `packages/core/src/schemas/style.ts`
- `packages/core/src/schemas/index.ts`
- `packages/core/src/style/provider.tsx`
- `packages/core/src/style/theme-provider.tsx`
- `packages/core/src/style/variants-provider.tsx`
- `packages/core/src/style/index.ts`
- `packages/core/src/components/create-dynamic-component.tsx`
- `packages/core/src/components/index.ts`
- `packages/core/src/index.ts`
- `packages/core/package.json` (updated exports)

---

## Phase 3: Connect Components to Core

Update registry components to use `createDynamicComponent` from core.

### Tasks

1. [ ] **Update registry package.json**
   - Add `@dotui/core` as dependency

2. [ ] **Update component exports**
   - Components that have variants should use `createDynamicComponent`
   - Import from `@dotui/core/components/create-dynamic-component`

3. [ ] **Update component structure**
   ```typescript
   // Before: registry/src/ui/button/index.tsx
   export { Button } from './basic';

   // After: registry/src/ui/button/index.tsx
   import { createDynamicComponent } from '@dotui/core/components/create-dynamic-component';
   import { BasicButton } from './basic';
   import { RippleButton } from './ripple';

   export const Button = createDynamicComponent('button', {
     basic: BasicButton,
     ripple: RippleButton,
   });
   ```

4. [ ] **Test variant switching**
   - Ensure StyleProvider variant selection works
   - Ensure default variant fallback works

### Files to Modify
- `packages/registry/package.json`
- `packages/registry/src/ui/*/index.tsx` (components with variants)

---

## Phase 4: Database Package Updates

Update `@dotui/db` with new schemas.

### Tasks

1. [ ] **Update style table schema**
   ```typescript
   // packages/db/src/schemas/style.ts
   export const style = pgTable("style", {
     id: uuid("id").notNull().primaryKey().defaultRandom(),
     name: text("name").notNull(),
     description: text("description"),
     visibility: text("visibility", { enum: ["public", "unlisted", "private"] }),
     isFeatured: boolean("is_featured").notNull().default(false),
     isPreset: boolean("is_preset").notNull().default(false),  // NEW
     config: jsonb("config").$type<StyleConfig>().notNull(),   // CHANGED: single column
     userId: text("user_id").notNull(),
     createdAt: timestamp("created_at").defaultNow().notNull(),
     updatedAt: timestamp("updated_at"),
   });
   ```

2. [ ] **Create migration script**
   - Migrate existing `theme`, `icons`, `variants` columns to single `config` column
   - Add `is_preset` column

3. [ ] **Update tRPC routers**
   - Use new schema types from `@dotui/core/schemas`
   - Update validation to use `styleConfigSchema`

4. [ ] **Update db package.json**
   - Add `@dotui/core` as dependency (for types)

### Files to Modify
- `packages/db/src/schemas/style.ts`
- `packages/db/src/migrations/*.ts` (new migration)
- `packages/api/src/routers/style.ts`
- `packages/db/package.json`

---

## Phase 5: Update Imports

Update all imports across the project to use new packages.

### Tasks

1. [ ] **Update www/ imports**
   - Replace `@dotui/style-system` → `@dotui/core`
   - Replace `@dotui/shadcn-adapter` → `@dotui/core/shadcn`
   - Update style-editor to use `VARIANT_GROUPS` for UI

2. [ ] **Update API imports**
   - Use schemas from `@dotui/core/schemas`
   - Use types from `@dotui/core/types`

3. [ ] **Remove old packages**
   - Delete `packages/style-system/`
   - Delete `packages/shadcn-adapter/`
   - Delete `packages/transformers/` (merged into core/shadcn/transforms/)
   - Update root `package.json` workspaces
   - Update `pnpm-workspace.yaml` if needed

4. [ ] **Update all package references**
   - Search for any remaining imports
   - Update tsconfig paths if needed

### Files to Modify
- `apps/www/**/*.ts(x)` (many files)
- `packages/api/**/*.ts`
- Root `package.json`
- `pnpm-workspace.yaml`

---

## Phase 6: Documentation Website

> **Note: Skip for now - will plan separately**

---

# Summary

| Phase | Focus | Dependencies |
|-------|-------|--------------|
| 0 | @dotui/colors (schemas, API) | None |
| 1 | Registry (groups, CI) | None (parallel with Phase 0) |
| 2 | Core package | Phase 0 + Phase 1 |
| 3 | Components → Core | Phase 2 (createDynamicComponent) |
| 4 | Database schemas | Phase 2 (schemas/types) |
| 5 | Import updates | Phases 2, 3, 4 |
| 6 | Docs (later) | All above |

---

# Decisions Made

1. **No partial configs** - Require full StyleConfig, validation fails on missing fields
2. **Build trigger** - Chokidar watcher during dev + CI check that fails if `__registry__/` is out of sync
3. **Colors schemas in @dotui/colors** - `createThemeOptionsSchema` is the source of truth
4. **ColorsConfig = createThemeOptionsSchema** - Direct re-export, no wrapper. DB stores exactly what @dotui/colors expects
5. **Algorithm discriminator** - Colors config uses `algorithm: 'material' | 'contrast'` as discriminator
6. **Semantic colors shorthand** - `palettes: { success: true }` auto-generates with sensible defaults
7. **Typography over Fonts** - Use `typographyConfig` for font settings
8. **createDynamicComponent location** - `@dotui/core/components/` (separate from providers)
9. **Flat variants internally** - Groups only for style-editor UI
10. **Variants separate from components** - Keep `variants` and `components` as separate fields in StyleConfig
11. **Root scripts/ folder** - build-registry.ts at monorepo root (neutral location for cross-package tooling)
12. **Transformers merged into core** - @dotui/transformers merged into `core/shadcn/transforms/`
